name: Renovate Helm Chart Version Bump

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'charts/**/Chart.yaml'

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-chart-version:
    # Only run on Renovate PRs with helm-dependency label
    if: |
      github.actor == 'renovate[bot]' &&
      contains(github.event.pull_request.labels.*.name, 'helm-dependency')
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.HELM_BOT_APP_ID }}
          private-key: ${{ secrets.HELM_BOT_PRIVATE_KEY }}

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Extract dependency info from PR
        id: extract
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          # Extract dependency name and version from Chart.yaml changes
          git diff "origin/$BASE_REF" -- charts/kubeadapt/Chart.yaml > /tmp/chart.diff

          # Get changed dependency name and new version
          DEPENDENCY=$(grep -E '^\+.*name:' /tmp/chart.diff | sed 's/^+.*name: //' | tr -d '"' | head -1)
          NEW_VERSION=$(grep -E '^\+.*version:' /tmp/chart.diff | sed 's/^+.*version: //' | tr -d '"' | head -1)

          # Extract update type from PR title (major/minor/patch)
          UPDATE_TYPE=$(echo "$PR_TITLE" | grep -oE '\((major|minor|patch)\)' | tr -d '()')

          if [ -z "$DEPENDENCY" ] || [ -z "$NEW_VERSION" ] || [ -z "$UPDATE_TYPE" ]; then
            echo "Failed to extract dependency info"
            echo "DEPENDENCY=$DEPENDENCY"
            echo "NEW_VERSION=$NEW_VERSION"
            echo "UPDATE_TYPE=$UPDATE_TYPE"
            exit 1
          fi

          echo "dependency=$DEPENDENCY" >> $GITHUB_OUTPUT
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "type=$UPDATE_TYPE" >> $GITHUB_OUTPUT

      - name: Run version bump script
        env:
          DEPENDENCY: ${{ steps.extract.outputs.dependency }}
          VERSION: ${{ steps.extract.outputs.version }}
          TYPE: ${{ steps.extract.outputs.type }}
        run: |
          ./scripts/renovate-bump-version.sh \
            -c kubeadapt \
            -d "$DEPENDENCY" \
            -v "$VERSION" \
            -t "$TYPE"

      - name: Check if Chart.yaml was modified
        id: check-changes
        run: |
          if git diff --quiet charts/kubeadapt/Chart.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config user.name "renovate[bot]"
          git config user.email "29139614+renovate[bot]@users.noreply.github.com"

          git add charts/kubeadapt/Chart.yaml
          git commit --amend --no-edit
          git push --force-with-lease
